<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Session 5 lab exercise: loglinear regression part 2 • session5</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/lumen/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Session 5 lab exercise: loglinear regression part 2">
<meta property="og:description" content="session5">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-176789980-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-176789980-1');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">session5</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Lecture and Lab
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/session_lecture.html">Lecture notes</a>
    </li>
    <li>
      <a href="../articles/session_lecture.pdf">Lecture notes PDF</a>
    </li>
    <li class="divider">
    <li>
      <a href="../articles/session_lab.html">Lab materials</a>
    </li>
  </ul>
</li>
<li class="dropdown-header">
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/waldronbios2/session5/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="https://twitter.com/leviwaldron1">
    <span class="fab fa fab fa-twitter fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="session_lab_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Session 5 lab exercise: loglinear regression part 2</h1>
                        <h4 class="author">Levi Waldron</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/waldronbios2/session5/blob/master/vignettes/session_lab.Rmd"><code>vignettes/session_lab.Rmd</code></a></small>
      <div class="hidden name"><code>session_lab.Rmd</code></div>

    </div>

    
    
<div id="learning-objectives" class="section level1 unnumbered">
<h1 class="hasAnchor">
<a href="#learning-objectives" class="anchor"></a>Learning objectives</h1>
<ol style="list-style-type: decimal">
<li>Fit Poisson, NB, and zero-inflated loglinear models</li>
<li>Perform nested deviance test for model selection</li>
<li>Make diagnostic plots of loglinear models</li>
<li>Visually assess multicollinearity among predictors</li>
</ol>
</div>
<div id="load-the-needle-sharing-dataset" class="section level1">
<h1 class="hasAnchor">
<a href="#load-the-needle-sharing-dataset" class="anchor"></a>Load the needle-sharing dataset</h1>
<div class="sourceCode" id="cb1"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span></pre></div>
<pre><code>## Warning: package 'tidyverse' was built under R version 4.0.3</code></pre>
<pre><code>## Warning: package 'purrr' was built under R version 4.0.3</code></pre>
<pre><code>## Warning: package 'stringr' was built under R version 4.0.3</code></pre>
<div class="sourceCode" id="cb5"><pre class="downlit">
<span class="va">needledat</span> <span class="op">&lt;-</span> <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span><span class="st">"needle_sharing.csv"</span><span class="op">)</span>
<span class="va">needledat2</span> <span class="op">&lt;-</span> <span class="va">needledat</span> <span class="op">%&gt;%</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">sex</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"M"</span>, <span class="st">"F"</span><span class="op">)</span> <span class="op">&amp;</span>
                  <span class="va">ethn</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"White"</span>, <span class="st">"AA"</span>, <span class="st">"Hispanic"</span><span class="op">)</span> <span class="op">&amp;</span>
                  <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">homeless</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>
    homeless <span class="op">=</span> <span class="fu">recode_factor</span><span class="op">(</span><span class="va">homeless</span>, <span class="st">"0"</span> <span class="op">=</span> <span class="st">"no"</span>, <span class="st">"1"</span> <span class="op">=</span> <span class="st">"yes"</span><span class="op">)</span>,
    hiv <span class="op">=</span> <span class="fu">recode_factor</span><span class="op">(</span>
      <span class="va">hivstat</span>,
      <span class="st">"0"</span> <span class="op">=</span> <span class="st">"negative"</span>,
      <span class="st">"1"</span> <span class="op">=</span> <span class="st">"positive"</span>,
      <span class="st">"2"</span> <span class="op">=</span> <span class="st">"positive"</span>
    <span class="op">)</span>
  <span class="op">)</span></pre></div>
</div>
<div id="compare-the-mean-to-the-variance-of-the-outcome-variable--calculate-what-fraction-of-the-counts-are-zero-" class="section level1">
<h1 class="hasAnchor">
<a href="#compare-the-mean-to-the-variance-of-the-outcome-variable--calculate-what-fraction-of-the-counts-are-zero-" class="anchor"></a>Compare the mean to the variance of the outcome variable. Calculate what fraction of the counts are zero.</h1>
<div class="sourceCode" id="cb6"><pre class="downlit">
<span class="va">meanvarzeros</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">needledat2</span>,<span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">shared_syr</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">summarise</span><span class="op">(</span>
    mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">shared_syr</span><span class="op">)</span>,
    var <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html">var</a></span><span class="op">(</span><span class="va">shared_syr</span><span class="op">)</span>,
    fraczero <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">shared_syr</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">/</span> <span class="fu">n</span><span class="op">(</span><span class="op">)</span>
  <span class="op">)</span>
<span class="va">meanvarzeros</span></pre></div>
<pre><code>## # A tibble: 1 x 3
##    mean   var fraczero
##   &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;
## 1  3.12  113.    0.774</code></pre>
<p>The mean number of needle sharing events per participant is 3.12, the variance is 113, and the fraction of participants who never shared a needle is 0.774. (Note how I put computed results in the text here rather than writing in numbers manually - they will change automatically if the analysis is changed!)</p>
</div>
<div id="create-a-histogram-of-the-outcome-variable-" class="section level1">
<h1 class="hasAnchor">
<a href="#create-a-histogram-of-the-outcome-variable-" class="anchor"></a>Create a histogram of the outcome variable.</h1>
<p>This was done in the lecture using base R, but let’s do it here with ggplot2. Note the filtering of complete cases only is unnecessary because ggplot does it anyways, but this gets rid of a warning (try it without filtering). Specifying the binwidth is also unnecessary, but by default geom_histogram creates histogram bins of size 2 (ie 0 and 1 in the same bin, 2 and 3 together, …)</p>
<div class="sourceCode" id="cb8"><pre class="downlit">
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">needledat2</span>, <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">shared_syr</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">shared_syr</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span>binwidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></pre></div>
<p><img src="session_lab_files/figure-html/unnamed-chunk-2-1.png" width="700"></p>
</div>
<div id="fit-poisson-and-negative-binomial-models-as-in-the-lecture-with-and-without-zero-inflation-" class="section level1">
<h1 class="hasAnchor">
<a href="#fit-poisson-and-negative-binomial-models-as-in-the-lecture-with-and-without-zero-inflation-" class="anchor"></a>Fit Poisson and Negative Binomial models as in the lecture, with and without zero inflation.</h1>
<div id="poisson" class="section level2">
<h2 class="hasAnchor">
<a href="#poisson" class="anchor"></a>Poisson</h2>
<div class="sourceCode" id="cb9"><pre class="downlit">
<span class="va">fit.pois</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span><span class="op">(</span><span class="va">shared_syr</span> <span class="op">~</span> <span class="va">sex</span> <span class="op">+</span> <span class="va">ethn</span> <span class="op">+</span> <span class="va">homeless</span>,
                data <span class="op">=</span> <span class="va">needledat2</span>,
                family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">poisson</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">"log"</span><span class="op">)</span><span class="op">)</span></pre></div>
</div>
<div id="negative-binomial" class="section level2">
<h2 class="hasAnchor">
<a href="#negative-binomial" class="anchor"></a>Negative Binomial</h2>
<div class="sourceCode" id="cb10"><pre class="downlit">
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://www.stats.ox.ac.uk/pub/MASS4/">MASS</a></span><span class="op">)</span></pre></div>
<pre><code>## 
## Attaching package: 'MASS'</code></pre>
<pre><code>## The following object is masked from 'package:dplyr':
## 
##     select</code></pre>
<div class="sourceCode" id="cb13"><pre class="downlit">
<span class="va">fit.negbin</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/MASS/man/glm.nb.html">glm.nb</a></span><span class="op">(</span><span class="va">shared_syr</span> <span class="op">~</span> <span class="va">sex</span> <span class="op">+</span> <span class="va">ethn</span> <span class="op">+</span> <span class="va">homeless</span>,
                data <span class="op">=</span> <span class="va">needledat2</span><span class="op">)</span></pre></div>
</div>
<div id="zero-inflated-poisson" class="section level2">
<h2 class="hasAnchor">
<a href="#zero-inflated-poisson" class="anchor"></a>Zero-inflated Poisson</h2>
<p>The <code>|1</code> creates an intercept-only zero inflation model. Substitute it with a variable name to add that variable to the count model, and use regular model formula syntax to create any zero-inflation logistic regression model you want. Or omit the <code><a href="https://rdrr.io/r/base/Logic.html">|</a></code> for a full zero-inflation model.</p>
<div class="sourceCode" id="cb14"><pre class="downlit">
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://github.com/atahk/pscl">pscl</a></span><span class="op">)</span></pre></div>
<pre><code>## Warning: package 'pscl' was built under R version 4.0.3</code></pre>
<pre><code>## Classes and Methods for R developed in the
## Political Science Computational Laboratory
## Department of Political Science
## Stanford University
## Simon Jackman
## hurdle and zeroinfl functions by Achim Zeileis</code></pre>
<div class="sourceCode" id="cb17"><pre class="downlit">
<span class="va">fit.ZIpoisfull</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/pscl/man/zeroinfl.html">zeroinfl</a></span><span class="op">(</span><span class="va">shared_syr</span> <span class="op">~</span> <span class="va">sex</span> <span class="op">+</span> <span class="va">ethn</span> <span class="op">+</span> <span class="va">homeless</span>,
                data <span class="op">=</span> <span class="va">needledat2</span>,
                dist <span class="op">=</span> <span class="st">"poisson"</span><span class="op">)</span></pre></div>
</div>
<div id="intercept-only-zi-poisson-model" class="section level2">
<h2 class="hasAnchor">
<a href="#intercept-only-zi-poisson-model" class="anchor"></a>Intercept-only ZI Poisson model</h2>
<div class="sourceCode" id="cb18"><pre class="downlit">
<span class="va">fit.ZIpois</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/pscl/man/zeroinfl.html">zeroinfl</a></span><span class="op">(</span><span class="va">shared_syr</span> <span class="op">~</span> <span class="va">sex</span> <span class="op">+</span> <span class="va">ethn</span> <span class="op">+</span> <span class="va">homeless</span> <span class="op">|</span> <span class="fl">1</span>,
                data <span class="op">=</span> <span class="va">needledat2</span>,
                dist <span class="op">=</span> <span class="st">"poisson"</span><span class="op">)</span></pre></div>
</div>
<div id="intercept-only-zi-negative-binomial-model" class="section level2">
<h2 class="hasAnchor">
<a href="#intercept-only-zi-negative-binomial-model" class="anchor"></a>Intercept-only ZI Negative Binomial model</h2>
<div class="sourceCode" id="cb19"><pre class="downlit">
<span class="va">fit.ZInegbin</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/pscl/man/zeroinfl.html">zeroinfl</a></span><span class="op">(</span><span class="va">shared_syr</span> <span class="op">~</span> <span class="va">sex</span> <span class="op">+</span> <span class="va">ethn</span> <span class="op">+</span> <span class="va">homeless</span> <span class="op">|</span> <span class="fl">1</span>,
                data <span class="op">=</span> <span class="va">needledat2</span>,
                dist <span class="op">=</span> <span class="st">"negbin"</span><span class="op">)</span></pre></div>
</div>
<div id="make-a-boxplot-of-needle-sharing-by-homelessness-and-other-predictors" class="section level2">
<h2 class="hasAnchor">
<a href="#make-a-boxplot-of-needle-sharing-by-homelessness-and-other-predictors" class="anchor"></a>Make a boxplot of needle sharing by homelessness (and other predictors)</h2>
<div class="sourceCode" id="cb20"><pre class="downlit">
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">needledat2</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">ethn</span>, y <span class="op">=</span> <span class="va">shared_syr</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html">geom_boxplot</a></span><span class="op">(</span>varwidth <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></pre></div>
<pre><code>## Warning: Removed 2 rows containing non-finite values (stat_boxplot).</code></pre>
<p><img src="session_lab_files/figure-html/unnamed-chunk-8-1.png" width="700"></p>
</div>
</div>
<div id="assess-whether-there-may-be-multicollinearity-among-the-predictors" class="section level1">
<h1 class="hasAnchor">
<a href="#assess-whether-there-may-be-multicollinearity-among-the-predictors" class="anchor"></a>Assess whether there may be multicollinearity among the predictors</h1>
<p>This uses <code>model.matrix</code> as a trick to produce a numeric matrix containing numeric and dummy variables, that can be used for calculating correlations and plotting heatmaps or dendrograms. First, assessing only three variables. Note, the first column of <code>mm</code> is the intercept, which must be removed.</p>
<div class="sourceCode" id="cb22"><pre class="downlit">
<span class="va">mm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="va">sex</span> <span class="op">+</span> <span class="va">ethn</span> <span class="op">+</span> <span class="va">homeless</span>, data <span class="op">=</span> <span class="va">needledat2</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/hclust.html">hclust</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/dist.html">as.dist</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html">cor</a></span><span class="op">(</span><span class="va">mm</span><span class="op">[</span>, <span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></pre></div>
<p><img src="session_lab_files/figure-html/unnamed-chunk-9-1.png" width="700"></p>
<p>Now embed the dendrogram in a heatmap, which may be more or less informative, but worth trying. Here I use Euclidian distance for rows (patients) because some rows have zero variance and produce an error when attempting to calculate correlation, but use Pearson correlation for columns. The choice of distance metric makes this clustering look very different. See <code><a href="https://rdrr.io/pkg/pheatmap/man/pheatmap.html">?pheatmap</a></code> for other distance metric options. There are also other heatmap packages, but <code><a href="https://rdrr.io/pkg/pheatmap/man/pheatmap.html">?pheatmap</a></code> makes it easy to produce a basic heatmap.</p>
<div class="sourceCode" id="cb23"><pre class="downlit">
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">pheatmap</span><span class="op">)</span></pre></div>
<pre><code>## Warning: package 'pheatmap' was built under R version 4.0.3</code></pre>
<div class="sourceCode" id="cb25"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/pkg/pheatmap/man/pheatmap.html">pheatmap</a></span><span class="op">(</span><span class="va">mm</span><span class="op">[</span>, <span class="op">-</span><span class="fl">1</span><span class="op">]</span>,
         clustering_distance_cols <span class="op">=</span> <span class="st">"correlation"</span>,
         clustering_distance_rows <span class="op">=</span> <span class="st">"euclidean"</span><span class="op">)</span></pre></div>
<p><img src="session_lab_files/figure-html/unnamed-chunk-10-1.png" width="700"></p>
<p>Now repeat but assessing all variables, removing <code>id</code> because it’s just an identifier, and <code>shsyryn</code> because it has zero variance.</p>
<div class="sourceCode" id="cb26"><pre class="downlit">
<span class="va">mm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="va">.</span> <span class="op">-</span> <span class="va">id</span> <span class="op">-</span> <span class="va">shsyryn</span>, data <span class="op">=</span> <span class="va">needledat2</span><span class="op">)</span><span class="op">[</span>, <span class="op">-</span><span class="fl">1</span><span class="op">]</span> <span class="co">#[, -1] gets rid of intercept</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/hclust.html">hclust</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/dist.html">as.dist</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html">cor</a></span><span class="op">(</span><span class="va">mm</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></pre></div>
<p><img src="session_lab_files/figure-html/unnamed-chunk-11-1.png" width="700"></p>
<div class="sourceCode" id="cb27"><pre class="downlit">
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">pheatmap</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/pheatmap/man/pheatmap.html">pheatmap</a></span><span class="op">(</span><span class="va">mm</span>,
         clustering_distance_cols <span class="op">=</span> <span class="st">"correlation"</span>,
         clustering_distance_rows <span class="op">=</span> <span class="st">"correlation"</span><span class="op">)</span></pre></div>
<p><img src="session_lab_files/figure-html/unnamed-chunk-11-2.png" width="700"></p>
</div>
<div id="use-chi-square-nested-deviance-tests-to-assess-which-model-seems-to-fit-best-" class="section level1">
<h1 class="hasAnchor">
<a href="#use-chi-square-nested-deviance-tests-to-assess-which-model-seems-to-fit-best-" class="anchor"></a>Use chi-square nested deviance tests to assess which model seems to fit best.</h1>
<p>I want to calculate the log-likelihood from each model. The simplest way is to call the <code>logLik</code> function one at a time:</p>
<div class="sourceCode" id="cb28"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/stats/logLik.html">logLik</a></span><span class="op">(</span><span class="va">fit.pois</span><span class="op">)</span></pre></div>
<pre><code>## 'log Lik.' -730.0133 (df=5)</code></pre>
<div class="sourceCode" id="cb30"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/stats/logLik.html">logLik</a></span><span class="op">(</span><span class="va">fit.negbin</span><span class="op">)</span></pre></div>
<pre><code>## 'log Lik.' -147.1277 (df=6)</code></pre>
<div class="sourceCode" id="cb32"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/stats/logLik.html">logLik</a></span><span class="op">(</span><span class="va">fit.ZIpois</span><span class="op">)</span></pre></div>
<pre><code>## 'log Lik.' -303.0276 (df=6)</code></pre>
<div class="sourceCode" id="cb34"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/stats/logLik.html">logLik</a></span><span class="op">(</span><span class="va">fit.ZInegbin</span><span class="op">)</span></pre></div>
<pre><code>## 'log Lik.' -146.7677 (df=7)</code></pre>
<p>Just to demonstrate a fancier way that could be used on many models, I’ll create a list of model objects:</p>
<div class="sourceCode" id="cb36"><pre class="downlit">
<span class="va">listoffits</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    pois <span class="op">=</span> <span class="va">fit.pois</span>,
    negbin <span class="op">=</span> <span class="va">fit.negbin</span>,
    ZIpois <span class="op">=</span> <span class="va">fit.ZIpois</span>,
    ZInegbin <span class="op">=</span> <span class="va">fit.ZInegbin</span>
  <span class="op">)</span></pre></div>
<p>Then demonstrate how the <code>lapply</code> (also related functions like <code>sapply</code>) can be used to implicitly loop over elements of a list, to do exactly the same thing:</p>
<div class="sourceCode" id="cb37"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">listoffits</span>, <span class="va">logLik</span><span class="op">)</span></pre></div>
<pre><code>## $pois
## 'log Lik.' -730.0133 (df=5)
## 
## $negbin
## 'log Lik.' -147.1277 (df=6)
## 
## $ZIpois
## 'log Lik.' -303.0276 (df=6)
## 
## $ZInegbin
## 'log Lik.' -146.7677 (df=7)</code></pre>
<p>OK now to actually answer the question. Just to get an idea of how big a difference in <span class="math inline">\(-2 \times log(likelihood)\)</span> would be statistically significant on one difference of degrees of freedom:</p>
<div class="sourceCode" id="cb39"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/stats/Chisquare.html">qchisq</a></span><span class="op">(</span><span class="fl">0.95</span>, df <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></pre></div>
<pre><code>## [1] 3.841459</code></pre>
<p>Or two degrees of freedom:</p>
<div class="sourceCode" id="cb41"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/stats/Chisquare.html">qchisq</a></span><span class="op">(</span><span class="fl">0.95</span>, df <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></pre></div>
<pre><code>## [1] 5.991465</code></pre>
<p>All the differences in double log-likelihoods above are <em>much</em> larger (in the hundreds) than these critical significance values, except for the difference between Negative Binomial and zero-inflated negative binomial models. So it doesn’t look like zero inflation helped the Negative Binomial distribution model, but it helped the Poisson model, and the Negative Binomial model fits better than the Poisson model.</p>
</div>
<div id="create-residual-deviance-plots-using-the-functions-defined-in-the-lecture-" class="section level1">
<h1 class="hasAnchor">
<a href="#create-residual-deviance-plots-using-the-functions-defined-in-the-lecture-" class="anchor"></a>Create residual deviance plots using the functions defined in the lecture.</h1>
<p>These were the (base graphics) functions defined to create the first two panels of residuals plots for all of these types of models.</p>
<div class="sourceCode" id="cb43"><pre class="downlit">
<span class="va">plotpanel1</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">fit</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span>
    x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span>,
    y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span><span class="op">(</span><span class="va">fit</span>, type <span class="op">=</span> <span class="st">"pearson"</span><span class="op">)</span>,
    xlab <span class="op">=</span> <span class="st">"Predicted Values"</span>,
    ylab <span class="op">=</span> <span class="st">"Pearson Residuals"</span>,
    <span class="va">...</span>
  <span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span><span class="op">(</span>h <span class="op">=</span> <span class="fl">0</span>, lty <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lowess.html">lowess</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">resid</a></span><span class="op">(</span><span class="va">fit</span>, type <span class="op">=</span> <span class="st">"pearson"</span><span class="op">)</span><span class="op">)</span>,
        col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span>
<span class="op">}</span>
<span class="va">plotpanel2</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">fit</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">resids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span><span class="op">(</span><span class="va">fit</span>, type <span class="op">=</span> <span class="st">"pearson"</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/qqnorm.html">qqnorm</a></span><span class="op">(</span><span class="va">resids</span>, ylab <span class="op">=</span> <span class="st">"Std Pearson resid."</span>, <span class="va">...</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/qqnorm.html">qqline</a></span><span class="op">(</span><span class="va">resids</span><span class="op">)</span>
<span class="op">}</span></pre></div>
<p>Let’s make these plots. As a shortcut, remember that list of models? I’m going to use an explicit <code>for</code> loop this time instead of <code>lapply</code> so that I can use the vector names as plot titles.</p>
<p>Although we saw some evidence from the chi-square test that the Negative Binomial distribution fit better than the Poisson distribution (not surprising since these data are very over-dispersed), these diagnostic plots show the Negative Binomial distribution still does not fit well at all. I would take any interpretation of the coefficients of these models with plenty of skepticism. But this dataset is tricky and I’m not sure offhand of a good model to fit it.</p>
<p>Note, the line <code><a href="https://rdrr.io/r/graphics/par.html">par(mfrow=c(1, 2))</a></code> only works for base graphics (not ggplot2), and creates a 1 row by 2 column plot panel.</p>
<div class="sourceCode" id="cb44"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">listoffits</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="fu">plotpanel1</span><span class="op">(</span><span class="va">listoffits</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, main <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">listoffits</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>
  <span class="fu">plotpanel2</span><span class="op">(</span><span class="va">listoffits</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, main <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">listoffits</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>
<span class="op">}</span></pre></div>
<p><img src="session_lab_files/figure-html/unnamed-chunk-18-1.png" width="700"><img src="session_lab_files/figure-html/unnamed-chunk-18-2.png" width="700"><img src="session_lab_files/figure-html/unnamed-chunk-18-3.png" width="700"><img src="session_lab_files/figure-html/unnamed-chunk-18-4.png" width="700"></p>
</div>
<div id="plot-predicted-and-observed-counts" class="section level1">
<h1 class="hasAnchor">
<a href="#plot-predicted-and-observed-counts" class="anchor"></a>Plot predicted and observed counts</h1>
<p>Here is a <code>data.frame</code> that we can use to make histograms, density plots, etc.</p>
<div class="sourceCode" id="cb45"><pre class="downlit">
<span class="va">preds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>observed <span class="op">=</span> <span class="va">fit.pois</span><span class="op">$</span><span class="va">y</span>,
                    poisson <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">fit.pois</span><span class="op">)</span>,
                    negbin <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">fit.negbin</span><span class="op">)</span>,
                    ZIpois <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">fit.ZIpois</span><span class="op">)</span>,
                    ZInegbin <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">fit.ZInegbin</span><span class="op">)</span><span class="op">)</span></pre></div>
<p>Just to help with pivoting, let’s pivot this into long-format:</p>
<div class="sourceCode" id="cb46"><pre class="downlit">
<span class="va">preds.long</span> <span class="op">&lt;-</span> <span class="fu">pivot_longer</span><span class="op">(</span><span class="va">preds</span>, <span class="fu">everything</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></pre></div>
<p>What did this do?</p>
<div class="sourceCode" id="cb47"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">preds.long</span><span class="op">)</span></pre></div>
<pre><code>##      name               value        
##  Length:575         Min.   :-0.5506  
##  Class :character   1st Qu.: 0.0000  
##  Mode  :character   Median : 1.1446  
##                     Mean   : 2.3125  
##                     3rd Qu.: 2.5691  
##                     Max.   :60.0000</code></pre>
<p>Boxplot</p>
<div class="sourceCode" id="cb49"><pre class="downlit">
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">preds.long</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">name</span>, y <span class="op">=</span> <span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html">geom_boxplot</a></span><span class="op">(</span><span class="op">)</span></pre></div>
<p><img src="session_lab_files/figure-html/unnamed-chunk-22-1.png" width="700"></p>
<p>Histogram with facet_wrap</p>
<div class="sourceCode" id="cb50"><pre class="downlit">
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">preds.long</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">name</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span>binwidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></pre></div>
<p><img src="session_lab_files/figure-html/unnamed-chunk-23-1.png" width="700"></p>
<p>We can see that none of the models come close to modeling the extreme observed counts of 30+. In reality, these might require a more complex mixture model: for example a mixture of zero-inflation plus two different count distributions, one with a much higher mean. This is beyond the scope of the course, but it is possible to fit more complex mixture models that could fit this dataset better.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="https://waldronlab.io">Levi Waldron</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
